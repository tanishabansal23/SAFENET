// client/src/components/MalwareScanner/MalwareScanner.jsx
import React, { useState } from "react";
import axios from "axios";
import Layout from "../Layout";
import "./MalwareScanner.css";

export default function MalwareScanner() {
  const [file, setFile] = useState(null);
  const [url, setUrl] = useState("");
  const [loading, setLoading] = useState(false);
  const [analysisId, setAnalysisId] = useState(null);
  const [result, setResult] = useState(null);
  const API = "http://localhost:3001/api";

  const uploadFile = async (e) => {
    e.preventDefault();
    if (!file) return alert("Select a file first");
    setLoading(true);
    setResult(null);
    setAnalysisId(null);

    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await axios.post(`${API}/scan-file`, formData, {
        headers: { "Content-Type": "multipart/form-data" },
      });
      setAnalysisId(res.data.analysis_id);
      pollResult(res.data.analysis_id);
    } catch (err) {
      console.error(err);
      alert("Upload failed");
      setLoading(false);
    }
  };

  const submitUrl = async (e) => {
    e.preventDefault();
    if (!url) return alert("Enter a URL");
    setLoading(true);
    setResult(null);
    setAnalysisId(null);

    try {
      const res = await axios.post(`${API}/scan-url`, { url });
      setAnalysisId(res.data.analysis_id);
      pollResult(res.data.analysis_id);
    } catch (err) {
      console.error(err);
      alert("URL scan failed");
      setLoading(false);
    }
  };

  // Poll until analysis.status === "completed" or timeout
  const pollResult = async (id, attempts = 0) => {
    try {
      const res = await axios.get(`${API}/scan-result/${id}`);
      const data = res.data;
      const status = data?.data?.attributes?.status;
      if (status === "completed" || attempts >= 12) {
        setResult(data);
        setLoading(false);
      } else {
        // wait 3s and poll again
        setTimeout(() => pollResult(id, attempts + 1), 3000);
      }
    } catch (err) {
      console.error("poll error:", err);
      setLoading(false);
    }
  };

  const friendlySummary = (data) => {
    const stats = data?.data?.attributes?.stats;
    if (!stats) return null;
    const {
      malicious = 0,
      suspicious = 0,
      harmless = 0,
      undetected = 0,
    } = stats;
    const verdict =
      malicious > 0 ? "Malicious" : suspicious > 0 ? "Suspicious" : "Clean";
    return { verdict, malicious, suspicious, harmless, undetected };
  };

  return (
    <Layout>
      <div className="scanner">
        <h2>üîç Malware Scanner</h2>

      <form onSubmit={uploadFile} className="scanner-row">
        <input type="file" onChange={(e) => setFile(e.target.files[0])} />
        <button type="submit">Scan File</button>
      </form>

      <form onSubmit={submitUrl} className="scanner-row">
        <input
          type="text"
          placeholder="Enter URL (https://example.com)"
          value={url}
          onChange={(e) => setUrl(e.target.value)}
        />
        <button type="submit">Scan URL</button>
      </form>

      {loading && (
        <p className="status">‚è≥ Scanning... (this may take a few seconds)</p>
      )}

      {result && (
        <div className="result">
          <h3>Scan Summary</h3>
          <p>
            Scanned:{" "}
            {result?.meta?.url_info?.url ||
              result?.meta?.file_info?.sha256 ||
              "N/A"}
          </p>
          <p>Status: {result?.data?.attributes?.status}</p>

          {friendlySummary(result) && (
            <>
              <p>
                Verdict: <strong>{friendlySummary(result).verdict}</strong>
              </p>
              <ul>
                <li>Malicious: {friendlySummary(result).malicious}</li>
                <li>Suspicious: {friendlySummary(result).suspicious}</li>
                <li>Harmless: {friendlySummary(result).harmless}</li>
                <li>Undetected: {friendlySummary(result).undetected}</li>
              </ul>
            </>
          )}

          {/* <a href={result?.data?.links?.self} target="_blank" rel="noreferrer">
            Open full VirusTotal report
          </a> */}
          {result?.data?.attributes?.results && (
            <div className="engine-results">
              <h4>Detailed Engine Results</h4>
              <table>
                <thead>
                  <tr>
                    <th>Engine</th>
                    <th>Category</th>
                    <th>Result</th>
                    {/* <th>Version</th>
                    <th>Update</th> */}
                  </tr>
                </thead>
                <tbody>
                  {Object.entries(result.data.attributes.results).map(
                    ([engine, info]) => (
                      <tr key={engine}>
                        <td>{info.engine_name}</td>
                        <td>{info.category || "N/A"}</td>
                        <td>
                          <span
                            className={`badge ${
                              info.category === "malicious"
                                ? "bad"
                                : info.category === "suspicious"
                                ? "warn"
                                : "good"
                            }`}
                          >
                            {info.result
                              ? info.result
                              : info.category === "harmless"
                              ? "Clean"
                              : "Undetected"}
                          </span>
                        </td>
                        {/* <td>{info.engine_version || "‚Äî"}</td>
                        <td>{info.engine_update || "‚Äî"}</td> */}
                      </tr>
                    )
                  )}
                </tbody>
              </table>
            </div>
          )}
        </div>
      )}
      </div>
    </Layout>
  );
}
